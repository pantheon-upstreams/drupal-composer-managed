<?php

/**
 * Implements hook_ENTITY_TYPE_presave().
 */
function surf_curriculum_download_request_presave(\Drupal\Core\Entity\EntityInterface $entity) {
  if ($entity->bundle() !== 'curriculum_module') {
    return;
  }
  if ($entity->field_dates->isEmpty() && !$entity->get('field_webform_submission_id')->isEmpty()) {
    $submission = \Drupal\webform\Entity\WebformSubmission::load($entity->field_webform_submission_id->value);
    $data = $submission->getData();
    if ($entity->field_dates->isEmpty()) {
      $value = [];
      if (!empty($data['date_start'])) {
        $value['value'] = $data['date_start'];
      }
      if (!empty($data['date_end'])) {
        $value['end_value'] = $data['date_end'];
      }
      $entity->field_dates->setValue($value);
    }
  }
  if ($entity->get('field_ref_curriculum_module')->target_id && !$entity->get('request_items')->target_id) {
    $node = $entity->get('field_ref_curriculum_module')->entity;
    $request_item = $node->createDownloadRequestItem();
    $request_item->save();
    $entity->get('request_items')->appendItem($request_item);
  }
}
/**
 * Implements hook_entity_bundle_info_alter().
 */
function surf_curriculum_entity_bundle_info_alter(array &$bundles): void {
  if (isset($bundles['node']['curriculum_module'])) {
    $bundles['node']['curriculum_module']['class'] = \Drupal\surf_curriculum\Entity\Node\CurriculumModule::class;
  }
}

/**
 * Implements hook_entity_extra_field_info().
 */
function surf_curriculum_entity_extra_field_info() {
  $extra = [];
  $extra['node']['curriculum_module']['display']['webform_link'] = [
    'label' => t('Webform link'),
    'description' => t('Link to webform with prepopulated node'),
    'visible' => TRUE,
    'weight' => 25,
  ];

  return $extra;
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function surf_curriculum_node_view(array &$build, \Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display, $view_mode) {
  if ($display->getComponent('webform_link') && $entity->bundle() === 'curriculum_module') {
    $build['webform_link'] = $entity->getWebformLink()->toRenderable();
  }
}
